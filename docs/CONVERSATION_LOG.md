# 對話紀錄摘要（new-cleansystem）

此文件彙總本專案至今的關鍵對話重點、決策與待辦，用於交接與追蹤。

## 目標與範圍
- 以 `docs` 為主、`cousor234` 行為為輔，重構派工系統（訂單/排班/薪資/積分/報表/RBAC）。
- 採 Repository Pattern；支援本機與 Supabase 雙資料源（可由 `VITE_USE_SUPABASE` 切換）。
- 介面改為更清晰（桌面側欄、技師行動友善）、站內通知、指派簽名、照片前/後等。

## 關鍵決策/修正（最新優先）
- 訂單頁：將「開始服務/無法服務/完成服務」自成欄位，置於「預約資訊」下、「服務照片」上；開始服務前顯示『我們的承諾』QR（來源頁：942clean），按「我知道了」後開始並啟動 20 分鐘冷卻；無法服務流程＝選擇車馬費(0/400)→填原因→客戶簽名→寫入備註並狀態改 `unservice`、必要時自動加入車馬費品項、付款狀態可為「不用付款」。結案需：冷卻完成＋雙簽名＋至少一張照片＋付款為已收款或不用付款。
- 訂單欄位：新增「積分抵扣」區、付款方式/狀態移至服務內容底部；來源平台僅 Admin/Support 可見與修改，顯示於頁首；「下單時間」唯讀顯示（不顯示「不可改」字樣）。
- 導覽徽章：統一改為「紅點」樣式，僅在有數量時顯示，不顯示數字 0。
- 技師介面：改用桌面版版型（上方顯示使用者與登出）；僅顯示快速入口（隱藏左側功能選單）。快速入口包含：訂單管理、排班/派工、回報管理、通知中心、薪資、個人設定。
- 訂單管理：上方提供「全部/待服務/已完成/已結案」篩選（之後可換卡牌樣式）。
- 薪資：技師與客服僅能看自己的薪資，管理員可看全部；後續新增「客服薪資表」欄位群（基本薪資/職務加給/加班費/獎金/其他、應扣款項、應領/實發）。
- 首頁：公告欄上移，快速入口下移並調整為「訂單管理、排班/派工、回報管理、通知中心、薪資、個人設定」。
- 回報中心：全員可用，支援類別（客訴/布達/提醒/其他）、對象（全員/技師/客服/部分名單）、訊息往返、結案；與報表功能區分。
- 倉庫改名：GitHub 改為 `a90046766/new-cleansystem`；已推送 `main`。Vercel 需連到此倉庫。
- Vercel 設定：
  - `vercel.json`（根目錄）生效，內容：
    - buildCommand: `npm run build`
    - outputDirectory: `dist`
    - rewrites: `/(.*)` → `/index.html`
  - Root Directory 留空；Production Branch=main；Build Command/Output 依上。
  - `VITE_USE_SUPABASE=0`（已關閉雲端，先用本機模式）。
- 首頁：移除「假資料已移除」；快速入口置頂；新增「公告欄」。
- Calendar：加入 `onDayHover`/`onDayLeave`，支援日期 hover 顯示「當日概覽」。
- 技師排班：
  - 從訂單點「指派技師」進入後，點日期會回填訂單的服務日期並自動返回訂單。
  - 當日概覽顯示：已排班（訂單編號/時間/地區/數量）與可排單技師（可勾選，後續按「確認指派」）。
- 訂單核心：
  - 完工時計分＝先扣 `pointsUsed`，再按淨額（扣抵後）計算新增點數。
  - 「確認」二次確認；未選簽名技師不可簽名。
- 自動回退：若 Supabase 變數缺失或請求失敗，自動退回本機適配器，避免雲端關閉時出錯。

## 既知問題/排程
- 排班「當日概覽」資訊可再補充（更完整的地區/數量來源、樣式強化）。
- 產品空清單時，已提供「建立預設產品」一鍵補種（本機/雲端皆透過 adapter）。
- 之後再開啟 Supabase 時，需確認資料表與 RLS 完整。

## 重新部署步驟（Vercel）
1. 確認 Vercel 連到 `a90046766/new-cleansystem`，Root Directory 留空，Build= `npm run build`，Output=`dist`。
2. Deployments → Redeploy（勾 Clear build cache）。
3. 瀏覽器硬重新整理（Ctrl+F5）。

## 快速驗證清單
- 首頁：僅「快速入口 + 公告欄」。
- 排班：滑到日期出現「當日概覽」；從訂單進入後點日期會回填服務日期並返回訂單。
- 訂單：開始服務前有『我們的承諾』QR；倒數 20 分鐘；無法服務流程可觸發並寫入備註；完成需雙簽名＋照片＋付款條件；完工後積分先扣 `pointsUsed` 再加淨額點數。


ƥ new942clean0824 @ 2025-08-24 15:38:47
