# 客戶管理增強功能

## 🎯 功能概述

客戶管理系統已經升級，提供快速搜索、服務紀錄自動記錄和智能客戶新增功能，讓客服和管理員能夠高效管理客戶資料。

## ✨ 新功能

### 1. 快速搜索功能
- **多欄位搜索**：可搜尋姓名、手機、地址、信箱、備註
- **即時過濾**：輸入時即時顯示符合的結果
- **智能匹配**：支持部分關鍵字匹配

### 2. 服務紀錄自動記錄
- **自動匹配**：根據手機號碼和信箱自動匹配訂單
- **歷史記錄**：顯示客戶的所有服務紀錄
- **詳細資訊**：包含訂單編號、日期、服務項目、金額
- **即時更新**：新增訂單時自動更新服務紀錄

### 3. 智能客戶新增
- **自動新增**：新建訂單時自動新增客戶資料
- **購物車整合**：客戶在購物車下單時自動新增
- **重複檢查**：避免重複新增相同客戶
- **資料完整性**：自動填入姓名、手機、地址等資訊

### 4. 客戶資料增強
- **備註欄位**：可記錄客戶相關備註
- **服務紀錄預覽**：編輯時可查看服務紀錄
- **黑名單管理**：標記不服務的客戶
- **多地址管理**：支援多個地址記錄

## 📋 功能詳解

### 快速搜索
```
搜尋範例：
- 姓名：輸入「王」找到所有姓王的客戶
- 手機：輸入「0912」找到手機號碼包含0912的客戶
- 地址：輸入「台北」找到地址包含台北的客戶
- 信箱：輸入「gmail」找到使用Gmail的客戶
```

### 服務紀錄顯示
每個客戶卡片會顯示：
- 📋 服務紀錄數量
- 最近3筆訂單詳情
- 訂單編號、日期、服務項目、金額
- 超過3筆時顯示「還有 X 筆紀錄...」

### 自動新增客戶流程
1. **新建訂單時**：
   - 檢查客戶手機號碼是否已存在
   - 如不存在，自動創建客戶資料
   - 備註標記為「自動從訂單新增」

2. **購物車預約時**：
   - 客戶在購物車下單
   - 客服確認轉換為正式訂單
   - 自動檢查並新增客戶資料
   - 備註標記為「自動從購物車預約新增」

## 🚀 使用方法

### 搜索客戶
1. 在搜索框輸入關鍵字
2. 系統會自動過濾結果
3. 支持多欄位搜索

### 查看服務紀錄
1. 客戶卡片會自動顯示服務紀錄
2. 點擊「編輯」可查看完整紀錄
3. 服務紀錄會即時更新

### 新增客戶
1. 手動新增：點擊「新增客戶」按鈕
2. 自動新增：新建訂單或確認購物車預約時自動新增

### 編輯客戶資料
1. 點擊客戶卡片上的「編輯」按鈕
2. 修改相關信息
3. 可查看服務紀錄預覽
4. 點擊「儲存」

## 🔧 技術實現

### 自動新增客戶邏輯
```typescript
// 檢查客戶是否存在
const existingCustomer = customers.find(c => c.phone === orderData.customerPhone)

// 如不存在則自動新增
if (!existingCustomer) {
  const newCustomer = {
    name: orderData.customerName,
    phone: orderData.customerPhone,
    email: orderData.customerEmail || '',
    addresses: [{
      id: generateId(),
      address: orderData.customerAddress
    }],
    notes: '自動從訂單新增',
    blacklisted: false
  }
  await customerRepo.upsert(newCustomer)
}
```

### 服務紀錄匹配邏輯
```typescript
// 根據手機號碼和信箱匹配訂單
const serviceHistory = orders.filter(order => {
  return order.customerPhone === customerPhone || 
         (customerEmail && order.customerEmail === customerEmail)
})
```

## 📱 響應式設計

- 桌面端：完整功能展示
- 平板端：適配中等螢幕
- 手機端：簡化界面，重點功能

## 🔒 安全考慮

- 重複檢查：避免重複新增客戶
- 錯誤處理：自動新增失敗不影響訂單創建
- 資料驗證：確保客戶資料完整性

## 🚀 部署說明

### 本地開發
```bash
npm run dev
```

### 生產環境更新
```bash
# 生成安全更新 SQL
npm run safe-update:enhance-customers

# 在 Supabase Dashboard 執行生成的 SQL
# 或使用命令行
npx supabase db push --include-all
```

## 📊 性能優化

- 前端搜索優化
- 服務紀錄緩存
- 自動新增非阻塞

## 🔮 未來規劃

- [ ] 客戶標籤系統
- [ ] 客戶分級管理
- [ ] 客戶統計報表
- [ ] 客戶溝通記錄
- [ ] 客戶滿意度調查
- [ ] 客戶推薦系統

## 📞 支援

如有問題，請聯繫開發團隊或查看相關文檔。
